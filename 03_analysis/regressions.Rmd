---
title: "Associations between pharmacy closures and county economic indicators"
author: "Maitreyi Sahu"
date: "2023-10-20"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

rm(list=ls())

pacman::p_load(dplyr, ggplot2, 
               lme4, # hierarchical model
               kableExtra, texreg)

dir <- "C:/Users/msahu/OneDrive - UW/Documents/Research/PCMA/"
data_dir <- paste0(dir, "00_data/processed/")

df <- readRDS(paste0(data_dir, "merged_data_long_lagged.rds"))

# Set up data frame for forest plot

forest_plotDF <- data.frame(
  
  Variable = as.character(),
  Model = as.character(),
  Metric = as.character(),
  Estimate = as.numeric(),
  Lower_95 = as.numeric(),
  Upper_95 = as.numeric()
  
)
```

### Risk of pharmacy closures on county-level unemployment, with a fixed effect for year [economic variable is lagged by 1 year]

```{r, echo = T}
# RISK RATIO using log-binomial regression, and 95% CI
m1.rr <- glm(Closure ~ unemployment_pct + as.factor(Year), data = df, family = binomial(link = "log"))
rr <- exp(coef(m1.rr)[[2]])
rr_ci <- exp(confint(m1.rr)["unemployment_pct", ])

# ODDS RATIO using logistic regression, and 95% CI
m2.or <- glm(Closure ~ unemployment_pct + as.factor(Year), data = df, family = binomial(link = "logit"))
or <- exp(coef(m2.or)[[2]])
or_ci <- exp(confint(m2.or)["unemployment_pct", ])
```

```{r, echo = F, warning = F, message = F}
# Forest plot table
plotDF_row1 <- c("Unemployment proportion", "GLM", "Risk Ratio", rr, rr_ci)
plotDF_row2 <- c("Unemployment proportion", "GLM", "Odds Ratio", or, or_ci)
forest_plotDF <- rbind(forest_plotDF, plotDF_row1, plotDF_row2)

# Table
table = matrix(c(rr, rr_ci, or, or_ci), byrow = T, ncol = 3)
colnames(table) = c("Estimate", "95% CI: Lower", "95% CI: Upper")
rownames(table) = c("Risk Ratio", "Odds Ratio")
kable(table, digits = 2)  %>% kable_styling(full_width = F)
```

   
### Risk of pharmacy closures on county-level unemployment, with a fixed effect for year and random effect for county [economic variable is lagged by 1 year] ... getting some convergence errors

```{r, echo = T, eval = F}
# RISK RATIO using log-binomial regression, and 95% CI
m1.rr <- glmer(Closure ~ unemployment_pct + as.factor(Year) + (1|county_fips), data = df, family = binomial(link = "log"))
beta1hat <- fixef(m1.rr)[[2]]
rr <- exp(beta1hat)
se <- summary(m1.rr)$coef[, 2, drop = FALSE]["unemployment_pct", ] 
rr_ci <- c(exp(beta1hat - qnorm(0.975)*se), exp(beta1hat + qnorm(0.975)*se))

# ODDS RATIO using logistic regression, and 95% CI
m2.or <- glmer(Closure ~ unemployment_pct + as.factor(Year) + (1|county_fips), data = df, family = binomial(link = "logit"))
beta1hat <- fixef(m2.or)[[2]]
or <- exp(beta1hat)
se <- summary(m2.or)$coef[, 2, drop = FALSE]["unemployment_pct", ] 
or_ci <- c(exp(beta1hat - qnorm(0.975)*se), exp(beta1hat + qnorm(0.975)*se))

# NOTE -- THIS CODE IS SUPER SLOW, EACH REGRESSION TAKES AROUND 15-20 MIN.... see if there's a way to speed up??
```

```{r, echo = F, warning = F, message = F}
# Forest plot table
plotDF_row1 <- c("Unemployment proportion", "GLMER", "Risk Ratio", rr, rr_ci)
plotDF_row2 <- c("Unemployment proportion", "GLMER", "Odds Ratio", or, or_ci)
forest_plotDF <- rbind(forest_plotDF, plotDF_row1, plotDF_row2)

# Table
table = matrix(c(rr, rr_ci, or, or_ci), byrow = T, ncol = 3)
colnames(table) = c("Estimate", "95% CI: Lower", "95% CI: Upper")
rownames(table) = c("Risk Ratio", "Odds Ratio")
kable(table, digits = 2)  %>% kable_styling(full_width = F)
```
    
    
    

### Risk of pharmacy closures on labor force, with a fixed effect for year [economic variable is lagged by 1 year]
### Note, probably need to log or normalize this variable

```{r, echo = T}
# RISK RATIO using log-binomial regression, and 95% CI
m1.rr <- glm(Closure ~ labor_force + as.factor(Year), data = df, family = binomial(link = "log"))
rr <- exp(coef(m1.rr)[[2]])
rr_ci <- exp(confint(m1.rr)["labor_force", ])

# ODDS RATIO using logistic regression, and 95% CI
m2.or <- glm(Closure ~ labor_force + as.factor(Year), data = df, family = binomial(link = "logit"))
or <- exp(coef(m2.or)[[2]])
or_ci <- exp(confint(m2.or)["labor_force", ])
```

```{r, echo = F, warning = F, message = F}
# Forest plot table
plotDF_row1 <- c("Labor force", "GLM", "Risk Ratio", rr, rr_ci)
plotDF_row2 <- c("Labor force", "GLM", "Odds Ratio", or, or_ci)
forest_plotDF <- rbind(forest_plotDF, plotDF_row1, plotDF_row2)

# Table
table = matrix(c(rr, rr_ci, or, or_ci), byrow = T, ncol = 3)
colnames(table) = c("Estimate", "95% CI: Lower", "95% CI: Upper")
rownames(table) = c("Risk Ratio", "Odds Ratio")
kable(table, digits = 2)  %>% kable_styling(full_width = F)
```


### Risk of pharmacy closures on labor force, with a fixed effect for year and random effect for county [economic variable is lagged by 1 year] ... not run due to convergence errors!

```{r, echo = F, warning = F, message = F, eval = F}
# RISK RATIO using log-binomial regression, and 95% CI
m1.rr <- glmer(Closure ~ labor_force + as.factor(Year) + (1|county_fips), data = df, family = binomial(link = "log"))
beta1hat <- fixef(m1.rr)[[2]]
rr <- exp(beta1hat)
se <- summary(m1.rr)$coef[, 2, drop = FALSE]["labor_force", ] 
rr_ci <- c(exp(beta1hat - qnorm(0.975)*se), exp(beta1hat + qnorm(0.975)*se))

# ODDS RATIO using logistic regression, and 95% CI
m2.or <- glmer(Closure ~ labor_force + as.factor(Year) + (1|county_fips), data = df, family = binomial(link = "logit"))
beta1hat <- fixef(m2.or)[[2]]
or <- exp(beta1hat)
se <- summary(m2.or)$coef[, 2, drop = FALSE]["labor_force", ] 
or_ci <- c(exp(beta1hat - qnorm(0.975)*se), exp(beta1hat + qnorm(0.975)*se))
```


```{r, echo = F, warning = F, message = F, eval = F}
# Forest plot table
plotDF_row1 <- c("Labor force", "GLMER", "Risk Ratio", rr, rr_ci)
plotDF_row2 <- c("Labor force", "GLMER", "Odds Ratio", or, or_ci)
forest_plotDF <- rbind(forest_plotDF, plotDF_row1, plotDF_row2)

# Table
table = matrix(c(rr, rr_ci, or, or_ci), byrow = T, ncol = 3)
colnames(table) = c("Estimate", "95% CI: Lower", "95% CI: Upper")
rownames(table) = c("Risk Ratio", "Odds Ratio")
kable(table, digits = 2)  %>% kable_styling(full_width = F)
```
  
  

### Forest plot

```{r, echo = F, warning = F, message = F}

forest_plotDF <- forest_plotDF %>% 
  
  rename(Variable = 1,
         Model = 2, 
         Metric = 3) 

forest_plotDF$Estimate <-  as.numeric(forest_plotDF[, 4])
forest_plotDF$Lower_95 <-  as.numeric(forest_plotDF[, 5])
forest_plotDF$Upper_95 <-  as.numeric(forest_plotDF[, 6])
  
ggplot(data = forest_plotDF) +
  geom_vline(xintercept = 0, linetype = "dashed") +
  geom_segment(aes(xmin = Lower_95, xmax = Upper_95, y = 1, yend = y)) +
  geom_point(aes(x = Estimate, y = 1), size = 3) +
  xlab("Estimate") +
  theme_classic()


```

