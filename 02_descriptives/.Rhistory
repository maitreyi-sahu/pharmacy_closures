install.packages("fastmap")
install.packages("fastmap")
knitr::opts_chunk$set(echo = TRUE)
rm(list=ls())
pacman::p_load(dplyr, gtsummary, flextable, ggplot2,
usmap, wesanderson)
dir <- "C:/Users/msahu/OneDrive - UW/Documents/Research/PCMA/"
in_dir <- paste0(dir, "00_data/processed/NCPDP/")
data <- readRDS(paste0(in_dir, "ncpdp_cleaned.rds")) %>%
mutate(closure = ifelse(closure_date != "00000000", 1, 0),
"Year of Closure" = closure_year,
"Pharmacy Type" = classR)
dataset_name <- "National Council for Prescription Drug Programs (NCDP), June 2023"
# Table output for Word (change YAML to "word_document")
# theme_gtsummary_printer(
#   print_engine = "flextable",
#   set_theme = TRUE
# )
data %>% select(`Pharmacy Type`, closure_year, closure, type1, type2, type3) %>%  tbl_summary()
data %>% select(closure, closure_year, `Pharmacy Type`, type1, type2, type3) %>%  tbl_summary()
data %>% select(closure, closure_year, `Pharmacy Type`, open24hours) %>%  tbl_summary()
knitr::opts_chunk$set(echo = TRUE)
rm(list=ls())
pacman::p_load(dplyr, gtsummary, flextable, ggplot2,
usmap, wesanderson)
dir <- "C:/Users/msahu/OneDrive - UW/Documents/Research/PCMA/"
in_dir <- paste0(dir, "00_data/processed/NCPDP/")
data <- readRDS(paste0(in_dir, "ncpdp_cleaned.rds")) %>%
mutate(closure = ifelse(closure_date != "00000000", 1, 0),
"Pharmacy Closures" = closure,
"Year of Closure" = closure_year,
"Pharmacy Type" = classR,
`Open 24 Hours?` = ifelse(open24hours == "Y", "Yes", "No"))
dataset_name <- "National Council for Prescription Drug Programs (NCDP), June 2023"
# Table output for Word (change YAML to "word_document")
# theme_gtsummary_printer(
#   print_engine = "flextable",
#   set_theme = TRUE
# )
data %>% select(closure, `Year of closure`, `Pharmacy Type`, open24hours) %>%  tbl_summary()
data %>% select(`Pharmacy Closures`, `Year of Closure`, `Pharmacy Type`, `Open 24 Hours?`) %>%  tbl_summary()
rm(list=ls())
library(RColorBrewer)
par(mar=c(3,4,2,2))
display.brewer.all()
library(RColorBrewer)
display.brewer.all(type = "seq")
par(mar=c(3,4,2,2))
display.brewer.all()
library(RColorBrewer)
par(mar=c(3,4,2,2))
display.brewer.all()
pal <- brewer.pal(5, "PrGN")  # we select 5 colors from the palette
library(RColorBrewer)
par(mar=c(3,4,2,2))
display.brewer.all()
pal <- brewer.pal(5, "PRGn")  # we select 5 colors from the palette
knitr::opts_chunk$set(echo = TRUE)
# Setup
rm(list=ls())
pacman::p_load(dplyr, gtsummary, flextable, ggplot2,
usmap, wesanderson)
# Word doc options
# theme_gtsummary_printer(
#   print_engine = "flextable",
#   set_theme = TRUE
# )
# YAML:
# output:
#  word_document:
#    reference_docx: word_styles.docx
# Load and clean data
dir <- "C:/Users/msahu/OneDrive - UW/Documents/Research/PCMA/"
in_dir <- paste0(dir, "00_data/processed/NCPDP/")
data <- readRDS(paste0(in_dir, "ncpdp_cleaned.rds")) %>%
mutate(closure = ifelse(closure_date != "00000000", 1, 0),
"Pharmacy Closures" = closure,
"Year of Closure" = closure_year,
"Pharmacy Type" = classR,
`Open 24 Hours?` = ifelse(open24hours == "Y", "Yes", "No"))
dataset_name <- "National Council for Prescription Drug Programs (NCDP), June 2023"
countyDF <- data %>%  group_by(county_fips) %>% summarize(closures_n = sum(closure)) %>% rename(fips = county_fips) %>% filter( fips!= "" & closures_n != 0)
plot_usmap(data = countyDF, regions = "counties", values = "closures_n") +
labs(title = "Pharmacy closures by US county",
subtitle = dataset_name) +
scale_fill_gradientn(colours = c("pink","green"), name = "Closures (n)", label = scales::comma) +
theme(legend.position = "right")
countyDF <- data %>%  group_by(county_fips) %>% summarize(closures_n = sum(closure)) %>% rename(fips = county_fips) %>% filter( fips!= "" & closures_n != 0)
plot_usmap(data = countyDF, regions = "counties", values = "closures_n") +
labs(title = "Pharmacy closures by US county",
subtitle = dataset_name) +
scale_fill_gradientn(colours = c("purple","darkgreen"), name = "Closures (n)", label = scales::comma) +
theme(legend.position = "right")
countyDF <- data %>%  group_by(county_fips) %>% summarize(closures_n = sum(closure)) %>% rename(fips = county_fips) %>% filter( fips!= "" & closures_n != 0)
plot_usmap(data = countyDF, regions = "counties", values = "closures_n") +
labs(title = "Pharmacy closures by US county",
subtitle = dataset_name) +
scale_fill_gradientn(colours = c("white","red"), name = "Closures (n)", label = scales::comma) +
theme(legend.position = "right")
countyDF <- data %>%  group_by(county_fips) %>% summarize(closures_n = sum(closure)) %>% rename(fips = county_fips) %>% filter( fips!= "" & closures_n != 0)
plot_usmap(data = countyDF, regions = "counties", values = "closures_n") +
labs(title = "Pharmacy closures by US county",
subtitle = dataset_name) +
scale_fill_gradientn(colours = c("white","orangered"), name = "Closures (n)", label = scales::comma) +
theme(legend.position = "right")
countyDF <- data %>%  group_by(county_fips) %>% summarize(closures_n = sum(closure)) %>% rename(fips = county_fips) %>% filter( fips!= "" & closures_n != 0)
plot_usmap(data = countyDF, regions = "counties", values = "closures_n") +
labs(title = "Pharmacy closures by US county",
subtitle = dataset_name) +
scale_fill_gradientn(colours = c("white","darkred"), name = "Closures (n)", label = scales::comma) +
theme(legend.position = "right")
countyDF <- data %>%  group_by(county_fips) %>% summarize(closures_n = sum(closure)) %>% rename(fips = county_fips) %>% filter( fips!= "" & closures_n != 0)
plot_usmap(data = countyDF, regions = "counties", values = "closures_n") +
labs(title = "Pharmacy closures by US county",
subtitle = dataset_name) +
scale_fill_gradientn(colours = c("white","brown4"), name = "Closures (n)", label = scales::comma) +
theme(legend.position = "right")
countyDF <- data %>%  group_by(county_fips) %>% summarize(closures_n = sum(closure)) %>% rename(fips = county_fips) %>% filter( fips!= "" & closures_n != 0)
plot_usmap(data = countyDF, regions = "counties", values = "closures_n") +
labs(title = "Pharmacy closures by US county",
subtitle = dataset_name) +
scale_fill_gradientn(colours = c("white","flame"), name = "Closures (n)", label = scales::comma) +
theme(legend.position = "right")
countyDF <- data %>%  group_by(county_fips) %>% summarize(closures_n = sum(closure)) %>% rename(fips = county_fips) %>% filter( fips!= "" & closures_n != 0)
plot_usmap(data = countyDF, regions = "counties", values = "closures_n") +
labs(title = "Pharmacy closures by US county",
subtitle = dataset_name) +
scale_fill_gradientn(colours = c("white","orangered3"), name = "Closures (n)", label = scales::comma) +
theme(legend.position = "right")
countyDF <- data %>%  group_by(county_fips) %>% summarize(closures_n = sum(closure)) %>% rename(fips = county_fips) %>% filter( fips!= "" & closures_n != 0)
plot_usmap(data = countyDF, regions = "counties", values = "closures_n") +
labs(title = "Pharmacy closures by US county",
subtitle = dataset_name) +
scale_fill_gradientn(colours = c("papayawhip","orangered3"), name = "Closures (n)", label = scales::comma) +
theme(legend.position = "right")
countyDF <- data %>%  group_by(county_fips) %>% summarize(closures_n = sum(closure)) %>% rename(fips = county_fips) %>% filter( fips!= "" & closures_n != 0)
plot_usmap(data = countyDF, regions = "counties", values = "closures_n") +
labs(title = "Pharmacy closures by US county",
subtitle = dataset_name) +
scale_fill_gradientn(colours = c("papayawhip","orangered4"), name = "Closures (n)", label = scales::comma) +
theme(legend.position = "right")
countyDF <- data %>%  group_by(county_fips) %>% summarize(closures_n = sum(closure)) %>% rename(fips = county_fips) %>% filter( fips!= "" & closures_n != 0)
plot_usmap(data = countyDF, regions = "counties", values = "closures_n") +
labs(title = "Pharmacy closures by US county",
subtitle = dataset_name) +
scale_fill_gradientn(colours = c("papayawhip","orangered3"), name = "Closures (n)", label = scales::comma) +
theme(legend.position = "right")
countyDF <- data %>%  group_by(county_fips) %>% summarize(closures_n = sum(closure)) %>% rename(fips = county_fips) %>% filter( fips!= "" & closures_n != 0)
plot_usmap(data = countyDF, regions = "counties", values = "closures_n") +
labs(title = "Pharmacy closures by US county",
subtitle = dataset_name) +
scale_fill_gradientn(colours = c("papayawhip","red3"), name = "Closures (n)", label = scales::comma) +
theme(legend.position = "right")
countyDF <- data %>%  group_by(county_fips) %>% summarize(closures_n = sum(closure)) %>% rename(fips = county_fips) %>% filter( fips!= "" & closures_n != 0)
plot_usmap(data = countyDF, regions = "counties", values = "closures_n") +
labs(title = "Pharmacy closures by US county",
subtitle = dataset_name) +
scale_fill_gradientn(colours = c("white","red3"), name = "Closures (n)", label = scales::comma) +
theme(legend.position = "right")
stateDF <- data %>%  group_by(state_code) %>% summarize(closures_n = sum(closure)) %>% rename(state = state_code)
plot_usmap(data = stateDF, regions = "states", values = "closures_n") +
labs(title = "Pharmacy closures by US state",
subtitle = dataset_name) +
scale_fill_gradientn(colours = c("white","red3"), name = "Closures (n)", label = scales::comma) +
theme(legend.position = "right")
countyDF <- data %>%  group_by(county_fips) %>% summarize(closures_n = sum(closure)) %>% rename(fips = county_fips) %>% filter( fips!= "")
plot_usmap(data = countyDF, regions = "counties", values = "closures_n") +
labs(title = "Pharmacy closures by US county",
subtitle = dataset_name) +
scale_fill_gradientn(colours = c("white","red3"), name = "Closures (n)", label = scales::comma) +
theme(legend.position = "right")
countyDF <- data %>%  group_by(county_fips) %>% summarize(closures_n = sum(closure)) %>% rename(fips = county_fips) %>% filter( fips!= "")
plot_usmap(data = countyDF, regions = "counties", values = "closures_n") +
labs(title = "Pharmacy closures by US county",
subtitle = dataset_name) +
scale_fill_gradientn(colours = c("white","red3"), name = "Closures (n)", label = scales::comma) +
annotate("text", x = 4, y = 25, label = "Some text") +
theme(legend.position = "right")
countyDF <- data %>%  group_by(county_fips) %>% summarize(closures_n = sum(closure)) %>% rename(fips = county_fips) %>% filter( fips!= "")
plot_usmap(data = countyDF, regions = "counties", values = "closures_n") +
labs(title = "Pharmacy closures by US county",
subtitle = dataset_name) +
scale_fill_gradientn(colours = c("white","red3"), name = "Closures (n)", label = scales::comma) +
annotate("text", label = "Some text") +
theme(legend.position = "right")
countyDF <- data %>%  group_by(county_fips) %>% summarize(closures_n = sum(closure)) %>% rename(fips = county_fips) %>% filter( fips!= "")
plot_usmap(data = countyDF, regions = "counties", values = "closures_n") +
labs(title = "Pharmacy closures by US county",
subtitle = paste0(dataset_name, " [Note: gray counties didn't map from NCPDP data]")) +
scale_fill_gradientn(colours = c("white","red3"), name = "Closures (n)", label = scales::comma) +
theme(legend.position = "right")
knitr::opts_chunk$set(echo = TRUE)
# Setup
rm(list=ls())
pacman::p_load(dplyr, gtsummary, kableExtra, flextable, ggplot2,
usmap, RColorBrewer, wesanderson, viridis)
# Word doc options
# theme_gtsummary_printer(
#   print_engine = "flextable",
#   set_theme = TRUE
# )
# YAML:
# output:
#  word_document:
#    reference_docx: word_styles.docx
# Load and clean data
dir <- "C:/Users/msahu/OneDrive - UW/Documents/Research/PCMA/"
in_dir <- paste0(dir, "00_data/processed/NCPDP/")
data17_21 <- readRDS(paste0(in_dir, "ncpdp_cleaned.rds")) %>%
# Restrict to only those open between 2017-2021
filter(is.na(closure_year) | closure_year < 2022) %>%
# Clean vars
mutate("Pharmacy Closures" = closure17_21,
"Year of Closure" = ifelse(closure17_21 ==1, closure_year, NA),
"Pharmacy Type" = classR,
`Chain Name` = chain_name,
`Open 24 Hours?` = ifelse(open24hours == "Y", "Yes", "No"))
knitr::opts_chunk$set(echo = TRUE)
# Setup
rm(list=ls())
pacman::p_load(dplyr, gtsummary, kableExtra, flextable, ggplot2,
usmap, RColorBrewer, wesanderson, viridis)
# Word doc options
# theme_gtsummary_printer(
#   print_engine = "flextable",
#   set_theme = TRUE
# )
# YAML:
# output:
#  word_document:
#    reference_docx: word_styles.docx
# Load and clean data
dir <- "C:/Users/msahu/OneDrive - UW/Documents/Research/PCMA/"
in_dir <- paste0(dir, "00_data/processed/NCPDP/")
data17_21 <- readRDS(paste0(in_dir, "ncpdp_cleaned_with_dc.rds")) %>%
# Restrict to only those open between 2017-2021
filter(is.na(closure_year) | closure_year < 2022) %>%
# Clean vars
mutate("Pharmacy Closures" = closure17_21,
"Year of Closure" = ifelse(closure17_21 ==1, closure_year, NA),
"Pharmacy Type" = classR,
`Chain Name` = chain_name,
`Open 24 Hours?` = ifelse(open24hours == "Y", "Yes", "No"))
dataset_name <- "National Council for Prescription Drug Programs (NCDP), 2017-21"
plot_usmap(data = total_countyDF, regions = "counties", values = "pharmacyDiffPct17_21_cat", color = NA) +
labs(title = "Percent change in total number of pharmacies by county from January 2017 to January 2021",
subtitle = paste0(dataset_name, " [Note: gray counties had no pharmacies in 2017-21]")) +
scale_fill_brewer(name = "Difference from\n 2017-21 (%)", palette = "RdYlBu", direction = -1, na.value = "grey70") +
theme(legend.position = "right")
# summarize data at county level
total_countyDF <- data17_21 %>%  group_by(county_fips) %>%
summarize(activeJan2017 = sum(activeJan2017),
activeJan2021 = sum(activeJan2021)) %>%
mutate(pharmacyDiff17_21 = activeJan2021 - activeJan2017) %>%
mutate(pharmacyDiff17_21_cat = factor(
case_when(pharmacyDiff17_21 > 0 ~ "Increased",
pharmacyDiff17_21 == 0  &! (activeJan2017 == 0 & activeJan2021 == 0) ~ "Stayed the same",
pharmacyDiff17_21 < 0 & pharmacyDiff17_21 > -5 ~ "Decreased by 1-4",
pharmacyDiff17_21 <= -5 & pharmacyDiff17_21 > -10 ~ "Decreased by 5-9",
pharmacyDiff17_21 <= -10 ~ "Decreased by 10+"),
levels = c("Increased", "Stayed the same", "Decreased by 1-4", "Decreased by 5-9", "Decreased by 10+")  )) %>%
mutate(pharmacyDiffPct17_21 = 100*(activeJan2021 - activeJan2017)/activeJan2017) %>%
mutate(pharmacyDiffPct17_21_cat = factor(
case_when(pharmacyDiffPct17_21 > 0 ~ "Increased",
pharmacyDiffPct17_21 == 0 ~ "Stayed the same",
pharmacyDiffPct17_21 < 0 & pharmacyDiffPct17_21 > -20 ~ "Decreased by 1-20%",
pharmacyDiffPct17_21 <= -20 & pharmacyDiffPct17_21 >= -50 ~ "Decreased by 21-50%",
pharmacyDiffPct17_21 < -50 ~ "Decreased by >50%"),
levels = c("Increased", "Stayed the same", "Decreased by 1-20%", "Decreased by 21-50%", "Decreased by >50%")  )) %>%
rename(fips = county_fips) %>% filter( fips!= "")
# MAPS OF TOTAL NUMBERS OF PHARMACIES - REMOVE B/C UGLY
# #plot - Jan 2017 [LOG THESE??]
# plot_usmap(data = total_countyDF, regions = "counties", values = "activeJan2017") +
#   labs(title = "Total number of pharmacies by county in January 2017",
#        subtitle = paste0(dataset_name, " [Note: gray counties had no pharmacies in 2017-21]")) +
#   scale_fill_viridis(name = "Total pharmacies, Jan 2017",  label = scales::comma, direction = 1) +
#   theme(legend.position = "right")
#
# #plot - Jan 2021 [LOG THESE??]
# plot_usmap(data = total_countyDF, regions = "counties", values = "activeJan2021") +
#   labs(title = "Total number of pharmacies by county in January 2021",
#        subtitle = paste0(dataset_name, " [Note: gray counties had no pharmacies in 2017-21]")) +
#   scale_fill_viridis(name = "Total pharmacies, Jan 2021",  label = scales::comma, direction = 1) +
#   theme(legend.position = "right")
# nice variable names
total_countyDF$`Total pharmacies, Jan 2017 (mean)` = total_countyDF$activeJan2017
total_countyDF$`Total pharmacies, Jan 2021 (mean)` = total_countyDF$activeJan2021
total_countyDF$`Difference in pharmacies, Jan 2017 to Jan 2021 (mean)` = total_countyDF$pharmacyDiff17_21
total_countyDF$`Difference in pharmacies, Jan 2017 to Jan 2021 (frequency)` = total_countyDF$pharmacyDiff17_21_cat
#total_countyDF$`Percent difference in pharmacies, Jan 2017 to Jan 2021 (mean)` = total_countyDF$pharmacyDiffPct17_21
total_countyDF$`Percent difference in pharmacies, Jan 2017 to Jan 2021 (frequency)` = total_countyDF$pharmacyDiffPct17_21_cat
# summary table
total_countyDF %>% select(`Total pharmacies, Jan 2017 (mean)`,
`Total pharmacies, Jan 2021 (mean)`,
`Difference in pharmacies, Jan 2017 to Jan 2021 (mean)`,
`Difference in pharmacies, Jan 2017 to Jan 2021 (frequency)`,
# `Percent difference in pharmacies, Jan 2017 to Jan 2021 (mean)`,
`Percent difference in pharmacies, Jan 2017 to Jan 2021 (frequency)`
) %>%
tbl_summary(
statistic = list(
all_continuous() ~ "{mean} ({sd})",
all_categorical() ~ "{n} / {N} ({p}%)"
),
missing_text = "No active pharmacies during 2017-21")
plot_usmap(data = total_countyDF, regions = "counties", values = "pharmacyDiff17_21_cat", color = NA) +
labs(title = "Difference in total number of pharmacies by county from January 2017 to January 2021",
subtitle = paste0(dataset_name, " [Note: gray counties had no pharmacies in 2017-21]")) +
scale_fill_brewer(name = "Difference from\n 2017-21 (N)", palette = "RdYlBu", direction = -1, na.value = "grey70") +
theme(legend.position = "right")
plot_usmap(data = total_countyDF, regions = "counties", values = "pharmacyDiff17_21_cat", color = NA) +
labs(title = "Difference in total number of pharmacies by county from January 2017 to January 2021",
subtitle = paste0(dataset_name, " [Note: gray counties had no pharmacies in 2017-21]")) +
geom_polygon(data = usmapdata::us_map(regions = "states"),
aes(x, y, group = group), fill = NA, size = .1, color = "grey20") +
scale_fill_brewer(name = "Difference from\n 2017-21 (N)", palette = "RdYlBu", direction = -1, na.value = "grey70") +
theme(legend.position = "right")
plot_usmap(data = total_countyDF, regions = "counties", values = "pharmacyDiff17_21_cat", color = NA) +
labs(title = "Difference in total number of pharmacies by county from January 2017 to January 2021",
subtitle = paste0(dataset_name, " [Note: gray counties had no pharmacies in 2017-21]")) +
geom_polygon(data = usmapdata::us_map(regions = "states"),
aes(x, y, group = group), fill = NA, size = .1, color = "grey20") +
scale_fill_brewer(name = "Difference from\n 2017-21 (N)", palette = "RdYlBu", direction = -1, na.value = "grey70") +
theme(legend.position = "right")
plot_usmap(data = total_countyDF, regions = "counties", values = "pharmacyDiffPct17_21_cat", color = NA) +
labs(title = "Percent change in total number of pharmacies by county from January 2017 to January 2021",
subtitle = paste0(dataset_name, " [Note: gray counties had no pharmacies in 2017-21]")) +
geom_polygon(data = usmapdata::us_map(regions = "states"),
aes(x, y, group = group), fill = NA, size = .1, color = "grey20") +
scale_fill_brewer(name = "Difference from\n 2017-21 (%)", palette = "RdYlBu", direction = -1, na.value = "grey70") +
theme(legend.position = "right")
