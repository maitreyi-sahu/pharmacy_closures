---
title: "NCPDP Descriptives for 2017-2021"
author: "Maitreyi Sahu"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# Setup
rm(list=ls())
pacman::p_load(dplyr, gtsummary, kableExtra, flextable, ggplot2,
               usmap, RColorBrewer, wesanderson, viridis)

# Word doc options 
# theme_gtsummary_printer(
#   print_engine = "flextable",
#   set_theme = TRUE
# )
# YAML:
# output: 
#  word_document:
#    reference_docx: word_styles.docx


# Load and clean data
dir <- "C:/Users/msahu/OneDrive - UW/Documents/Research/PCMA/"
in_dir <- paste0(dir, "00_data/processed/NCPDP/")

data17_21 <- readRDS(paste0(in_dir, "ncpdp_cleaned.rds")) %>% 
  
  # Restrict to only those open between 2017-2021
  
  filter(is.na(closure_year) | closure_year < 2022) %>% 
  
  # Clean vars
  mutate("Pharmacy Closures" = closure17_21,
         "Year of Closure" = ifelse(closure17_21 ==1, closure_year, NA),
         "Pharmacy Type" = classR,
         `Chain Name` = chain_name,
         `Open 24 Hours?` = ifelse(open24hours == "Y", "Yes", "No"))

dataset_name <- "National Council for Prescription Drug Programs (NCDP), 2017-21"

```


## Tabulated frequencies for all pharmacies open from 2017-2021

```{r, echo = F, warning = F, message = F}

data17_21 %>% select(`Pharmacy Closures`, `Year of Closure`, `Pharmacy Type`, `Open 24 Hours?`) %>%  tbl_summary(missing_text = "Remained open") 

```

## Number of closures by pharmacy type and year

```{r, echo = F, warning = F, message = F}

data17_21 %>% tbl_cross(row = `Pharmacy Type`, 
                   col = `Year of Closure`, 
                   percent = "col", missing = "no") %>% 
  add_p(test = "chisq.test")

```

## Percent of closures by pharmacy type and year

```{r, echo = F, warning = F, message = F}

data17_21 <- data17_21 %>% 
  group_by(classR) %>% 
  mutate(total2017jan = sum(activeJan2017),
         total2018jan = sum(activeJan2018),
         total2019jan = sum(activeJan2019),
         total2020jan = sum(activeJan2020),
         total2021jan = sum(activeJan2021),
         closure_denominator = case_when(
           closure_year == 2017 ~ total2017jan,
           closure_year == 2018 ~ total2018jan,
           closure_year == 2019 ~ total2019jan, 
           closure_year == 2020 ~ total2020jan,
           closure_year == 2021 ~ total2021jan,
           T ~ NA))

tbl <- data17_21 %>% group_by(closure_year, classR) %>% 
  summarize(closures_n = sum(closure17_21),
            pharmacies_n = mean(closure_denominator)) %>% 
  filter(!is.na(closure_year)) %>% 
  mutate(`closures_pct` = 100 * (closures_n / pharmacies_n) %>% round(3)) 

tbl <- tbl %>% 
  tidyr::pivot_wider(names_from = closure_year, values_from = c(closures_n, pharmacies_n, closures_pct)) %>% 
  select(classR, 
         closures_n_2017, pharmacies_n_2017, closures_pct_2017,
         closures_n_2018, pharmacies_n_2018, closures_pct_2018,
         closures_n_2019, pharmacies_n_2019, closures_pct_2019,
         closures_n_2020, pharmacies_n_2020, closures_pct_2020,
         closures_n_2021, pharmacies_n_2021, closures_pct_2021)

# Create the kable table with kableExtra
kable(tbl, format = "html", col.names = NULL) %>%
  add_header_above(
    c(" " = 1, 
    "Closures (n)" = 1, "Total (n)" = 1, "Closures (%)" = 1,
    "Closures (n)" = 1, "Total (n)" = 1, "Closures (%)" = 1, 
    "Closures (n)" = 1, "Total (n)" = 1, "Closures (%)" = 1, 
    "Closures (n)" = 1, "Total (n)" = 1, "Closures (%)"= 1, 
    "Closures (n)" = 1, "Total (n)" = 1, "Closures (%)" = 1),
    align = "c") %>%
  add_header_above(
     c(" " = 1, "2017" = 3, "2018" = 3, "2019" = 3, "2020" = 3, "2021" = 3),
     align = "c") %>%
  kable_styling(full_width = FALSE) 
```


### Figure: Pharmacy closures by pharmacy type and year

```{r, echo = F, warning = F, message = F}
ggplot(data = data17_21, aes(fill = `Pharmacy Type`, x = `Year of Closure`, y = closure)) + 
  geom_bar(position="stack", stat="identity") +
  ylab("Frequency") +
  theme_bw()  
```

### Figure: Closures by pharmacy chain and year, for chain pharmacies only

```{r, echo = F, warning = F, message = F}
ggplot(data = data17_21 %>% filter(classR == "Chain"), aes(fill = `Chain Name`, x = `Year of Closure`, y = closure)) + 
  geom_bar(position="stack", stat="identity") +
  scale_fill_brewer(palette = "Set3") +  # Use a palette with 12 colors
  ylab("Frequency") +
  theme_bw()  
```

### Figure: Pharmacy closures by whether open 24 hours and year

```{r, echo = F, warning = F, message = F}
ggplot(data = data17_21, aes(fill = `Open 24 Hours?`, x = `Year of Closure`, y = closure)) + 
  geom_bar(position="stack", stat="identity") +
  ylab("Frequency") +
  theme_bw()  
```

### Figure: Pharmacy closures by "Type1", 2017-21

```{r, echo = F, fig.width = 10}
df <- data17_21 %>% filter(!is.na(type1) )
ggplot(data = df, aes(x = type1, y = closure17_21, fill = type1)) + 
  geom_bar(stat="identity") +
  ylab("Frequency") +
  theme_bw() + coord_flip() +
  theme(legend.position = "none") 
```

## Figure: Number of pharmacy closures by state, 2017-2021

```{r, echo = F, warning = F}
stateDF <- data17_21 %>%  group_by(state_code) %>% 
  summarize(closures_n = sum(closure17_21), active_n = sum(active17_21), closures_pct = 100 * (closures_n/active_n)) %>% 
  rename(state = state_code)

plot_usmap(data = stateDF, regions = "states", values = "closures_n") + 
  labs(title = "Pharmacy closures by US state (N)",
       subtitle = dataset_name) + 
  scale_fill_viridis(name = "Closures (n)", label = scales::comma, direction = -1) + 
  theme(legend.position = "right")  
```

## Figure: Percent of pharmacy closures by state, 2017-2021

```{r, echo = F, warning = F}
plot_usmap(data = stateDF, regions = "states", values = "closures_pct") + 
  labs(title = "Pharmacy closures by US state (%)",
       subtitle = dataset_name) + 
    scale_fill_viridis(name = "Closures (%)", label = scales::comma, direction = -1) + 
  theme(legend.position = "right")  
```

# Figure: Number of pharmacy closures by county, 2017-2021

```{r, echo = F, warning = F}
countyDF <- data17_21 %>%  group_by(county_fips) %>% 
  summarize(closures_n = sum(closure17_21), active_n = sum(active17_21), closures_pct = 100 * (closures_n/active_n)) %>% 
  rename(fips = county_fips) %>% filter( fips!= "")

plot_usmap(data = countyDF, regions = "counties", values = "closures_n") + 
  labs(title = "Pharmacy closures by US county (N)",
       subtitle = paste0(dataset_name, " [Note: gray counties had no pharmacies in 2017-21]")) + 
    scale_fill_viridis(name = "Closures (n)",  label = scales::comma, direction = -1) + 
  theme(legend.position = "right")  
```

# Figure: Percent of pharmacy closures by county, 2017-2021

```{r, echo = F, warning = F}
plot_usmap(data = countyDF, regions = "counties", values = "closures_pct") + 
  labs(title = "Pharmacy closures by US county (%)",
       subtitle = paste0(dataset_name, " [Note: gray counties had no pharmacies in 2017-21]")) + 
  scale_fill_viridis(name = "Closures (%)",  label = scales::comma, direction = -1) + 
  theme(legend.position = "right")  
```
```{r, echo = F, warning = F}
# summarize data at county level
total_countyDF <- data17_21 %>%  group_by(county_fips) %>% 
  summarize(activeJan2017 = sum(activeJan2017), 
            activeJan2021 = sum(activeJan2021)) %>% 
  mutate(pharmacyDiff17_21 = activeJan2021 - activeJan2017) %>% 
  mutate(pharmacyDiff17_21_cat = factor(
           case_when(pharmacyDiff17_21 > 0 ~ "Increased",
                     pharmacyDiff17_21 == 0  &! (activeJan2017 == 0 & activeJan2021 == 0) ~ "Stayed the same",
                     pharmacyDiff17_21 < 0 & pharmacyDiff17_21 > -5 ~ "Decreased by 1-4",
                     pharmacyDiff17_21 <= -5 & pharmacyDiff17_21 > -10 ~ "Decreased by 5-9",
                      pharmacyDiff17_21 <= -10 ~ "Decreased by 10+"), 
           levels = c("Increased", "Stayed the same", "Decreased by 1-4", "Decreased by 5-9", "Decreased by 10+")  )) %>% 
  mutate(pharmacyDiffPct17_21 = 100*(activeJan2021 - activeJan2017)/activeJan2017) %>% 
  mutate(pharmacyDiffPct17_21_cat = factor(
           case_when(pharmacyDiffPct17_21 > 0 ~ "Increased",
                     pharmacyDiffPct17_21 == 0 ~ "Stayed the same",
                     pharmacyDiffPct17_21 < 0 & pharmacyDiffPct17_21 > -20 ~ "Decreased by 1-20%",
                     pharmacyDiffPct17_21 <= -20 & pharmacyDiffPct17_21 >= -50 ~ "Decreased by 21-50%",
                     pharmacyDiffPct17_21 < -50 ~ "Decreased by >50%"), 
           levels = c("Increased", "Stayed the same", "Decreased by 1-20%", "Decreased by 21-50%", "Decreased by >50%")  )) %>% 
  rename(fips = county_fips) %>% filter( fips!= "")

# MAPS OF TOTAL NUMBERS OF PHARMACIES - REMOVE B/C UGLY

# #plot - Jan 2017 [LOG THESE??]
# plot_usmap(data = total_countyDF, regions = "counties", values = "activeJan2017") + 
#   labs(title = "Total number of pharmacies by county in January 2017",
#        subtitle = paste0(dataset_name, " [Note: gray counties had no pharmacies in 2017-21]")) + 
#   scale_fill_viridis(name = "Total pharmacies, Jan 2017",  label = scales::comma, direction = 1) + 
#   theme(legend.position = "right")  
# 
# #plot - Jan 2021 [LOG THESE??]
# plot_usmap(data = total_countyDF, regions = "counties", values = "activeJan2021") + 
#   labs(title = "Total number of pharmacies by county in January 2021",
#        subtitle = paste0(dataset_name, " [Note: gray counties had no pharmacies in 2017-21]")) + 
#   scale_fill_viridis(name = "Total pharmacies, Jan 2021",  label = scales::comma, direction = 1) + 
#   theme(legend.position = "right")  
```

## Tabulated frequencies for total number of active pharmacies in January 2017 versus January 2021

```{r, echo = F, warning = F, message = F}

# nice variable names
total_countyDF$`Total pharmacies, Jan 2017 (mean)` = total_countyDF$activeJan2017
total_countyDF$`Total pharmacies, Jan 2021 (mean)` = total_countyDF$activeJan2021
total_countyDF$`Difference in pharmacies, Jan 2017 to Jan 2021 (mean)` = total_countyDF$pharmacyDiff17_21
total_countyDF$`Difference in pharmacies, Jan 2017 to Jan 2021 (frequency)` = total_countyDF$pharmacyDiff17_21_cat
#total_countyDF$`Percent difference in pharmacies, Jan 2017 to Jan 2021 (mean)` = total_countyDF$pharmacyDiffPct17_21
total_countyDF$`Percent difference in pharmacies, Jan 2017 to Jan 2021 (frequency)` = total_countyDF$pharmacyDiffPct17_21_cat

# summary table
total_countyDF %>% select(`Total pharmacies, Jan 2017 (mean)`, 
                          `Total pharmacies, Jan 2021 (mean)`, 
                          `Difference in pharmacies, Jan 2017 to Jan 2021 (mean)`,
                          `Difference in pharmacies, Jan 2017 to Jan 2021 (frequency)`,
                         # `Percent difference in pharmacies, Jan 2017 to Jan 2021 (mean)`,
                          `Percent difference in pharmacies, Jan 2017 to Jan 2021 (frequency)`
                          ) %>%  
  
  tbl_summary(
    statistic = list(
      all_continuous() ~ "{mean} ({sd})",
      all_categorical() ~ "{n} / {N} ({p}%)"
    ),
    missing_text = "No active pharmacies during 2017-21") 

```

## Figure: Change in total pharmacies during 2017-2021

```{r, echo = F, warning = F}

plot_usmap(data = total_countyDF, regions = "counties", values = "pharmacyDiff17_21_cat") + 
  labs(title = "Difference in total number of pharmacies by county from January 2017 to January 2021",
       subtitle = paste0(dataset_name, " [Note: gray counties had no pharmacies in 2017-21]")) + 
  scale_fill_brewer(name = "Difference from\n 2017-21 (N)", palette = "RdYlBu", direction = -1, na.value = "grey70") +
  theme(legend.position = "right")  
```

## Figure: Percent change in total pharmacies during 2017-2021

```{r, echo = F, warning = F}
plot_usmap(data = total_countyDF, regions = "counties", values = "pharmacyDiffPct17_21_cat") + 
  labs(title = "Percent change in total number of pharmacies by county from January 2017 to January 2021",
       subtitle = paste0(dataset_name, " [Note: gray counties had no pharmacies in 2017-21]")) + 
  scale_fill_brewer(name = "Difference from\n 2017-21 (%)", palette = "RdYlBu", direction = -1, na.value = "grey70") +
  theme(legend.position = "right")  
```


```{r, echo = F, include = F, warning = F, message = F}

# CREATE DATASET BY TYPE OF PHARMACY (COPIED FROM ABOVE)

# Summarize by type of pharmacy
total_countyDF_byType <- data17_21 %>%  group_by(county_fips, classR) %>% 
  summarize(activeJan2017 = sum(activeJan2017), 
            activeJan2021 = sum(activeJan2021)) %>% 
  mutate(pharmacyDiff17_21 = activeJan2021 - activeJan2017) %>% 
  mutate(pharmacyDiff17_21_cat = factor(
           case_when(pharmacyDiff17_21 > 0 ~ "Increased",
                     pharmacyDiff17_21 == 0 &! (activeJan2017 == 0 & activeJan2021 == 0) ~ "Stayed the same",
                     pharmacyDiff17_21 < 0 & pharmacyDiff17_21 > -5 ~ "Decreased by 1-4",
                     pharmacyDiff17_21 <= -5 & pharmacyDiff17_21 > -10 ~ "Decreased by 5-9",
                      pharmacyDiff17_21 <= -10 ~ "Decreased by 10+"), 
           levels = c("Increased", "Stayed the same", "Decreased by 1-4", "Decreased by 5-9", "Decreased by 10+")  )) %>% 
  mutate(pharmacyDiffPct17_21 = 100*(activeJan2021 - activeJan2017)/activeJan2017) %>% 
  mutate(pharmacyDiffPct17_21_cat = factor(
           case_when(pharmacyDiffPct17_21 > 0 ~ "Increased",
                     pharmacyDiffPct17_21 == 0 ~ "Stayed the same",
                     pharmacyDiffPct17_21 < 0 & pharmacyDiffPct17_21 > -20 ~ "Decreased by 1-20%",
                     pharmacyDiffPct17_21 <= -20 & pharmacyDiffPct17_21 >= -50 ~ "Decreased by 21-50%",
                     pharmacyDiffPct17_21 < -50 ~ "Decreased by >50%"), 
           levels = c("Increased", "Stayed the same", "Decreased by 1-20%", "Decreased by 21-50%", "Decreased by >50%")  )) %>% 
  rename(fips = county_fips) %>% filter( fips!= "") %>% 
  as.data.frame()

```


## **Independent pharmacies**: Tabulated frequencies for number of active pharmacies in January 2017 versus January 2021

```{r, echo = F, warning = F, message = F}

indept_countyDF <- total_countyDF_byType %>% filter(classR == "Independent")

# nice variable names
indept_countyDF$`Independent pharmacies, Jan 2017 (mean)` = indept_countyDF$activeJan2017
indept_countyDF$`Independent pharmacies, Jan 2021 (mean)` = indept_countyDF$activeJan2021
indept_countyDF$`Difference in independent pharmacies, Jan 2017 to Jan 2021 (mean)` = indept_countyDF$pharmacyDiff17_21
indept_countyDF$`Difference in independent pharmacies, Jan 2017 to Jan 2021 (frequency)` = indept_countyDF$pharmacyDiff17_21_cat
indept_countyDF$`Percent difference in independent pharmacies, Jan 2017 to Jan 2021 (frequency)` = indept_countyDF$pharmacyDiffPct17_21_cat

# summary table
indept_countyDF %>% 
  select(`Independent pharmacies, Jan 2017 (mean)`,
         `Independent pharmacies, Jan 2021 (mean)`, 
         `Difference in independent pharmacies, Jan 2017 to Jan 2021 (mean)`,
         `Difference in independent pharmacies, Jan 2017 to Jan 2021 (frequency)`,
         `Percent difference in independent pharmacies, Jan 2017 to Jan 2021 (frequency)`
         ) %>%  
  
  tbl_summary(
    statistic = list(
      all_continuous() ~ "{mean} ({sd})",
      all_categorical() ~ "{n} / {N} ({p}%)"
    ),
    missing_text = "No active independent pharmacies during 2017-21") 

```

## Figures: Change in **independent** pharmacies during 2017-2021 
```{r, echo = F, warning = F}

plot_usmap(data = indept_countyDF, regions = "counties", values = "pharmacyDiff17_21_cat") + 
  labs(title = "Difference in number of independent pharmacies by county from January 2017 to January 2021",
       subtitle = paste0(dataset_name, "[Note: gray counties had no independent pharmacies]")) + 
  scale_fill_brewer(name = "Difference from\n 2017-21 (N)", palette = "RdYlBu", direction = -1, na.value = "grey70") +
  theme(legend.position = "right")  

plot_usmap(data = indept_countyDF, regions = "counties", values = "pharmacyDiffPct17_21_cat") + 
  labs(title = "Percent change in independent pharmacies by county from January 2017 to January 2021",
       subtitle = paste0(dataset_name, " [Note: gray counties had no independent pharmacies]")) + 
  scale_fill_brewer(name = "Difference from\n 2017-21 (%)", palette = "RdYlBu", direction = -1, na.value = "grey70") +
  theme(legend.position = "right")  
```

## **Chain pharmacies**: Tabulated frequencies for number of active pharmacies in January 2017 versus January 2021

```{r, echo = F, warning = F, message = F}

chain_countyDF <- total_countyDF_byType %>% filter(classR == "Chain")

# nice variable names
chain_countyDF$`Chain pharmacies, Jan 2017 (mean)` = chain_countyDF$activeJan2017
chain_countyDF$`Chain pharmacies, Jan 2021 (mean)` = chain_countyDF$activeJan2021
chain_countyDF$`Difference in chain pharmacies, Jan 2017 to Jan 2021 (mean)` = chain_countyDF$pharmacyDiff17_21
chain_countyDF$`Difference in chain pharmacies, Jan 2017 to Jan 2021 (frequency)` = chain_countyDF$pharmacyDiff17_21_cat
chain_countyDF$`Percent difference in chain pharmacies, Jan 2017 to Jan 2021 (frequency)` = chain_countyDF$pharmacyDiffPct17_21_cat

# summary table
chain_countyDF %>% 
  select(`Chain pharmacies, Jan 2017 (mean)`,
         `Chain pharmacies, Jan 2021 (mean)`, 
         `Difference in chain pharmacies, Jan 2017 to Jan 2021 (mean)`,
         `Difference in chain pharmacies, Jan 2017 to Jan 2021 (frequency)`,
         `Percent difference in chain pharmacies, Jan 2017 to Jan 2021 (frequency)`
         ) %>%  
  
  tbl_summary(
    statistic = list(
      all_continuous() ~ "{mean} ({sd})",
      all_categorical() ~ "{n} / {N} ({p}%)"
    ),
    missing_text = "No active chain pharmacies during 2017-21") 

```

## Figures: Change in **chain** pharmacies during 2017-2021 

```{r, echo = F, warning = F}

plot_usmap(data = chain_countyDF, regions = "counties", values = "pharmacyDiff17_21_cat") + 
  labs(title = "Difference in number of chain pharmacies by county from January 2017 to January 2021",
       subtitle = paste0(dataset_name, " [Note: gray counties had no chain pharmacies in 2017-21]")) + 
  scale_fill_brewer(name = "Difference from\n 2017-21 (N)", palette = "RdYlBu", direction = -1, na.value = "grey70") +
  theme(legend.position = "right")  

plot_usmap(data = chain_countyDF, regions = "counties", values = "pharmacyDiffPct17_21_cat") + 
  labs(title = "Percent change in chain pharmacies by county from January 2017 to January 2021",
       subtitle = paste0(dataset_name, " [Note: gray counties had no chain pharmacies in 2017-21]")) + 
  scale_fill_brewer(name = "Difference from\n 2017-21 (%)", palette = "RdYlBu", direction = -1, na.value = "grey70") +
  theme(legend.position = "right")  
```