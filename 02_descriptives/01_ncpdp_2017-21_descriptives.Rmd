---
title: "NCPDP Descriptives for 2017-2021"
author: "Maitreyi Sahu"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# Setup
rm(list=ls())
pacman::p_load(dplyr, gtsummary, kableExtra, flextable, ggplot2,
               usmap, RColorBrewer, wesanderson)

# Word doc options 
# theme_gtsummary_printer(
#   print_engine = "flextable",
#   set_theme = TRUE
# )
# YAML:
# output: 
#  word_document:
#    reference_docx: word_styles.docx


# Load and clean data
dir <- "C:/Users/msahu/OneDrive - UW/Documents/Research/PCMA/"
in_dir <- paste0(dir, "00_data/processed/NCPDP/")

data17_21 <- readRDS(paste0(in_dir, "ncpdp_cleaned.rds")) %>% 
  
  # Restrict to only those open between 2017-2021
  
  filter(is.na(closure_year) | closure_year < 2022) %>% 
  
  # Clean vars
  mutate(closure = ifelse(is.na(closure_date), 0, 1),
         closure17_21 = ifelse(!is.na(closure_date) & closure_year %in% 2017:2021, 1, 0),
         "Pharmacy Closures" = closure17_21,
         "Year of Closure" = ifelse(closure17_21 ==1, closure_year, NA),
         "Pharmacy Type" = classR,
         `Chain Name` = chain_name,
         `Open 24 Hours?` = ifelse(open24hours == "Y", "Yes", "No"))

dataset_name <- "National Council for Prescription Drug Programs (NCDP), 2017-21"

```


## Tabulated frequencies for all pharmacies open from 2017-2021

```{r, echo = F, warning = F, message = F}

data17_21 %>% select(`Pharmacy Closures`, `Year of Closure`, `Pharmacy Type`, `Open 24 Hours?`) %>%  tbl_summary(missing_text = "Remained open") 

```

## Number of closures by pharmacy type and year

```{r, echo = F, warning = F, message = F}

data17_21 %>% tbl_cross(row = `Pharmacy Type`, 
                   col = `Year of Closure`, 
                   percent = "col", missing = "no") %>% 
  add_p(test = "chisq.test")

```

## Percent of closures by pharmacy type and year

```{r, echo = F, warning = F, message = F}

data17_21 <- data17_21 %>% 
  group_by(classR) %>% 
  mutate(total2017jan = sum(active2017jan),
         total2018jan = sum(active2018jan),
         total2019jan = sum(active2019jan),
         total2020jan = sum(active2020jan),
         total2021jan = sum(active2021jan),
         closure_denominator = case_when(
           closure_year == 2017 ~ total2017jan,
           closure_year == 2018 ~ total2018jan,
           closure_year == 2019 ~ total2019jan, 
           closure_year == 2020 ~ total2020jan,
           closure_year == 2021 ~ total2021jan,
           T ~ NA))

tbl <- data17_21 %>% group_by(closure_year, classR) %>% 
  summarize(closures_n = sum(closure17_21),
            pharmacies_n = mean(closure_denominator)) %>% 
  filter(!is.na(closure_year)) %>% 
  mutate(`closures_pct` = 100 * (closures_n / pharmacies_n) %>% round(3)) 

tbl <- tbl %>% 
  tidyr::pivot_wider(names_from = closure_year, values_from = c(closures_n, pharmacies_n, closures_pct)) %>% 
  select(classR, 
         closures_n_2017, pharmacies_n_2017, closures_pct_2017,
         closures_n_2018, pharmacies_n_2018, closures_pct_2018,
         closures_n_2019, pharmacies_n_2019, closures_pct_2019,
         closures_n_2020, pharmacies_n_2020, closures_pct_2020,
         closures_n_2021, pharmacies_n_2021, closures_pct_2021)

# Create the kable table with kableExtra
kable(tbl, format = "html", col.names = NULL) %>%
  add_header_above(
    c(" " = 1, 
    "Closures (n)" = 1, "Total (n)" = 1, "Closures (%)" = 1,
    "Closures (n)" = 1, "Total (n)" = 1, "Closures (%)" = 1, 
    "Closures (n)" = 1, "Total (n)" = 1, "Closures (%)" = 1, 
    "Closures (n)" = 1, "Total (n)" = 1, "Closures (%)"= 1, 
    "Closures (n)" = 1, "Total (n)" = 1, "Closures (%)" = 1),
    align = "c") %>%
  add_header_above(
     c(" " = 1, "2017" = 3, "2018" = 3, "2019" = 3, "2020" = 3, "2021" = 3),
     align = "c") %>%
  kable_styling(full_width = FALSE) 
```


### Figure: Pharmacy closures by pharmacy type and year

```{r, echo = F, warning = F, message = F}
ggplot(data = data17_21, aes(fill = `Pharmacy Type`, x = `Year of Closure`, y = closure)) + 
  geom_bar(position="stack", stat="identity") +
  ylab("Frequency") +
  theme_bw()  
```

### Figure: Closures by pharmacy chain and year, for chain pharmacies only

```{r, echo = F, warning = F, message = F}
ggplot(data = data17_21 %>% filter(classR == "Chain"), aes(fill = `Chain Name`, x = `Year of Closure`, y = closure)) + 
  geom_bar(position="stack", stat="identity") +
  scale_fill_brewer(palette = "Set3") +  # Use a palette with 12 colors
  ylab("Frequency") +
  theme_bw()  
```

### Figure: Pharmacy closures by whether open 24 hours and year

```{r, echo = F, warning = F, message = F}
ggplot(data = data17_21, aes(fill = `Open 24 Hours?`, x = `Year of Closure`, y = closure)) + 
  geom_bar(position="stack", stat="identity") +
  ylab("Frequency") +
  theme_bw()  
```

### Figure: Pharmacy closures by "Type1", 2017-21

```{r, echo = F, fig.width = 10}
df <- data17_21 %>% filter(!is.na(type1) )
ggplot(data = df, aes(x = type1, y = closure17_21, fill = type1)) + 
  geom_bar(stat="identity") +
  ylab("Frequency") +
  theme_bw() + coord_flip() +
  theme(legend.position = "none") 
```

## Figure: Number of pharmacy closures by state, 2017-2021

```{r, echo = F, warning = F}
data17_21 <-  data17_21 %>%  mutate(active17_21 = ifelse(active2017jan ==1 | active2018jan == 1 | active2019jan == 1 | active2020jan == 1 | active2021jan ==1, 1, 0))

stateDF <- data17_21 %>%  group_by(state_code) %>% 
  summarize(closures_n = sum(closure17_21), active_n = sum(active17_21), closures_pct = 100 * (closures_n/active_n)) %>% 
  rename(state = state_code)

plot_usmap(data = stateDF, regions = "states", values = "closures_n") + 
  labs(title = "Pharmacy closures by US state (N)",
       subtitle = dataset_name) + 
  scale_fill_gradientn(colours = c("white","red3"), name = "Closures (n)", label = scales::comma) + 
  theme(legend.position = "right")  
```

## Figure: Percent of pharmacy closures by state, 2017-2021

```{r, echo = F, warning = F}
plot_usmap(data = stateDF, regions = "states", values = "closures_pct") + 
  labs(title = "Pharmacy closures by US state (%)",
       subtitle = dataset_name) + 
  scale_fill_gradientn(colours = c("white","red3"), name = "Closures (%)", label = scales::comma) + 
  theme(legend.position = "right")  
```

# Figure: Number of pharmacy closures by county, 2017-2021

```{r, echo = F, warning = F}
countyDF <- data17_21 %>%  group_by(county_fips) %>% 
  summarize(closures_n = sum(closure17_21), active_n = sum(active17_21), closures_pct = 100 * (closures_n/active_n)) %>% 
  rename(fips = county_fips) %>% filter( fips!= "")

plot_usmap(data = countyDF, regions = "counties", values = "closures_n") + 
  labs(title = "Pharmacy closures by US county (N)",
       subtitle = paste0(dataset_name, " [Note: gray counties had no pharmacies in 2017-21]")) + 
  scale_fill_gradientn(colours = c("white","red3"), name = "Closures (n)", label = scales::comma) + 
  theme(legend.position = "right")  
```

# Figure: Percent of pharmacy closures by county, 2017-2021

```{r, echo = F, warning = F}
plot_usmap(data = countyDF, regions = "counties", values = "closures_pct") + 
  labs(title = "Pharmacy closures by US county (%)",
       subtitle = paste0(dataset_name, " [Note: gray counties had no pharmacies in 2017-21]")) + 
  scale_fill_gradientn(colours = c("white","red3"), name = "Closures (%)", label = scales::comma) + 
  theme(legend.position = "right")  
```
